# Environment & Secrets Management

The CrunchyCone Environment & Secrets Management system provides a unified interface for managing environment variables and secrets that automatically adapts to your runtime environment.

## üåç Overview

- **Local Development**: Manages `.env` files, secrets operations are no-ops with warnings
- **Platform Environment**: Uses CrunchyCone API for both environment variables and secrets
- **Automatic Detection**: `CRUNCHYCONE_PLATFORM=1` determines which provider to use
- **Unified Interface**: Same API works seamlessly across environments

## üöÄ Quick Start

```typescript
import { getCrunchyConeEnvironmentService, isPlatformEnvironment } from 'crunchycone-lib';

// Get the environment service (auto-detects provider)
const envService = getCrunchyConeEnvironmentService();

// Check which environment you're in
console.log('Platform environment:', isPlatformEnvironment());
console.log('Provider type:', envService.getProviderType()); // 'local' or 'remote'
console.log('Supports secrets:', envService.supportsSecrets());
```

## üîß Environment Detection

The system automatically detects your runtime environment:

### Local Development (Default)
```bash
# CRUNCHYCONE_PLATFORM not set or != "1"
export DATABASE_URL="postgres://localhost/myapp"
```
- Uses **Local Provider**
- Manages `.env` files in current working directory
- Environment variables: ‚úÖ Full support
- Secrets: ‚ùå No-op operations with console warnings

### Platform Environment
```bash
# Enable platform mode
export CRUNCHYCONE_PLATFORM=1
export CRUNCHYCONE_PROJECT_ID=your-project-id
export CRUNCHYCONE_API_KEY=your-api-key
```
- Uses **Remote Provider**
- Manages variables/secrets via CrunchyCone API
- Environment variables: ‚úÖ Full support
- Secrets: ‚úÖ Full support (write-only for security)

## üìù Environment Variables

Environment variables work in both local and platform environments:

```typescript
// Set environment variables
await envService.setEnvVar('DATABASE_URL', 'postgres://localhost/myapp');
await envService.setEnvVar('API_TIMEOUT', '30000');
await envService.setEnvVar('DEBUG_MODE', 'true');

// Get environment variables
const dbUrl = await envService.getEnvVar('DATABASE_URL');
const timeout = await envService.getEnvVar('API_TIMEOUT');

// List all environment variables
const allVars = await envService.listEnvVars();
console.log('Environment variables:', allVars);

// Delete environment variables
await envService.deleteEnvVar('OLD_VARIABLE');

// Bulk operations
await envService.setEnvVars({
  'APP_NAME': 'MyApplication',
  'VERSION': '1.0.0',
  'LOG_LEVEL': 'info'
});

const specific = await envService.getEnvVars(['APP_NAME', 'VERSION']);
console.log('App info:', specific); // { APP_NAME: 'MyApplication', VERSION: '1.0.0' }
```

### Local Environment (.env files)

In local development, variables are stored in `.env` files:

```bash
# .env file generated by the system
# Environment Variables
# Generated by CrunchyCone Environment Service

API_TIMEOUT=30000
APP_NAME="My Application"
DATABASE_URL=postgres://localhost/myapp
DEBUG_MODE=true
```

**Features:**
- Automatic quoting for values with spaces or special characters
- Proper escaping of quotes, newlines, and backslashes
- Sorted output for consistent file format
- Preserves existing variables when adding new ones

## üîê Secrets Management

Secrets are only supported in platform environment (`CRUNCHYCONE_PLATFORM=1`):

```typescript
// Check if secrets are supported
if (envService.supportsSecrets()) {
  // Set secrets (write-only)
  await envService.setSecret('JWT_SECRET', 'your-secret-jwt-key');
  await envService.setSecret('API_TOKEN', 'secret-api-token');
  await envService.setSecret('DATABASE_PASSWORD', 'secure-password');

  // List secret names (values are never returned for security)
  const secretNames = await envService.listSecretNames();
  console.log('Available secrets:', secretNames);
  // Output: ['JWT_SECRET', 'API_TOKEN', 'DATABASE_PASSWORD']

  // Delete secrets
  await envService.deleteSecret('OLD_SECRET');

  // Bulk set secrets
  await envService.setSecrets({
    'WEBHOOK_SECRET': 'webhook-signing-secret',
    'ENCRYPTION_KEY': 'data-encryption-key'
  });
} else {
  console.log('Secrets not supported in local environment');
}
```

### Local Environment Behavior

In local development, secret operations are no-ops:

```typescript
// These operations will warn but not throw errors
await envService.setSecret('SECRET_KEY', 'value'); 
// Console: "LocalEnvironmentProvider: Secrets are not supported locally. Ignoring setSecret('SECRET_KEY')"

await envService.deleteSecret('SECRET_KEY');
// Console: "LocalEnvironmentProvider: Secrets are not supported locally. Ignoring deleteSecret('SECRET_KEY')"

const secrets = await envService.listSecretNames();
console.log(secrets); // [] (empty array)
```

## ‚öôÔ∏è Configuration Options

### Basic Usage
```typescript
import { getCrunchyConeEnvironmentService } from 'crunchycone-lib';

// Uses global singleton with auto-detection
const envService = getCrunchyConeEnvironmentService();
```

### Custom Configuration
```typescript
import { createCrunchyConeEnvironmentService } from 'crunchycone-lib';

const envService = createCrunchyConeEnvironmentService({
  // Force provider (overrides environment detection)
  forceProvider: 'local', // or 'remote'
  
  // Local provider options
  dotEnvPath: './custom/.env',
  
  // Remote provider options
  projectId: 'custom-project-id',
  apiKey: 'custom-api-key',
  apiUrl: 'https://custom.api.com'
});
```

### Provider Information
```typescript
const info = envService.getProviderInfo();
console.log(info);
// {
//   type: 'local' | 'remote',
//   supportsSecrets: boolean,
//   isPlatformEnvironment: boolean
// }
```

## üîå Direct Provider Access

For advanced use cases, you can use providers directly:

### Local Provider
```typescript
import { LocalEnvironmentProvider } from 'crunchycone-lib';

const localProvider = new LocalEnvironmentProvider('./custom/.env');

await localProvider.setEnvVar('TEST_VAR', 'test-value');
const value = await localProvider.getEnvVar('TEST_VAR');
```

### Remote Provider
```typescript
import { RemoteEnvironmentProvider } from 'crunchycone-lib';

const remoteProvider = new RemoteEnvironmentProvider({
  projectId: 'your-project-id',
  apiKey: 'your-api-key'
});

await remoteProvider.setEnvVar('TEST_VAR', 'test-value');
await remoteProvider.setSecret('TEST_SECRET', 'secret-value');
```

## üåê Environment Variables Reference

### Required for Platform Mode
```bash
CRUNCHYCONE_PLATFORM=1                # Enables platform mode
CRUNCHYCONE_PROJECT_ID=your_project   # Project ID for API calls
```

### API Authentication (Auto-detected)
```bash
CRUNCHYCONE_API_KEY=your_api_key      # API key (checked first)
# Falls back to keychain if not set
```

### Optional Configuration
```bash
CRUNCHYCONE_API_URL=https://api.crunchycone.com  # Custom API URL
```

## üß™ Testing

The system includes comprehensive tests covering:

```bash
npm test -- --testPathPatterns="environment"
```

- Environment detection logic
- Provider selection
- Local .env file operations
- Remote API integration (mocked)
- Error handling
- Special character handling

## üîç Troubleshooting

### Common Issues

**1. "Project ID is required for RemoteEnvironmentProvider"**
```bash
# Set the project ID
export CRUNCHYCONE_PROJECT_ID=your-project-id
```

**2. "Failed to get API key for RemoteEnvironmentProvider"**
```bash
# Set API key or authenticate via CLI
export CRUNCHYCONE_API_KEY=your-api-key
# OR
npx crunchycone-cli auth login
```

**3. Permission errors with .env files**
```typescript
// Use custom path with proper permissions
const envService = createCrunchyConeEnvironmentService({
  dotEnvPath: '/writable/path/.env'
});
```

**4. Network errors in platform mode**
- Check API key permissions (needs `projects:read` and `projects:write` scopes)
- Verify project ID exists and you have access
- Check network connectivity to CrunchyCone API

### Debug Information

```typescript
// Get detailed provider information
const info = envService.getProviderInfo();
console.log('Environment info:', {
  provider: info.type,
  platform: info.isPlatformEnvironment,
  secrets: info.supportsSecrets,
  envVar: process.env.CRUNCHYCONE_PLATFORM
});

// For local provider, check .env file path
if (info.type === 'local') {
  const localProvider = envService.getProvider() as LocalEnvironmentProvider;
  console.log('Env file path:', localProvider.getDotEnvPath());
}

// For remote provider, check configuration
if (info.type === 'remote') {
  const remoteProvider = envService.getProvider() as RemoteEnvironmentProvider;
  console.log('Project ID:', remoteProvider.getProjectId());
  console.log('Has API key:', remoteProvider.hasApiKey());
}
```

## üîê Security Best Practices

1. **Never commit .env files** - Add to `.gitignore`
2. **Use secrets for sensitive data** in platform environment
3. **Rotate API keys** regularly
4. **Use minimal API key scopes** (`projects:read`, `projects:write`)
5. **Validate environment variables** before use
6. **Use HTTPS** for all API communications
7. **Monitor secret access** in platform dashboards

## üìö API Reference

See the [TypeScript definitions](../src/services/environment/types.ts) for complete API documentation with IntelliSense support.

### Main Interfaces

- `EnvironmentProvider` - Base provider interface
- `EnvironmentServiceConfig` - Configuration options
- `CrunchyConeEnvironmentService` - Main service class

### Key Methods

- `getEnvVar(key)` - Get environment variable
- `setEnvVar(key, value)` - Set environment variable
- `deleteEnvVar(key)` - Delete environment variable
- `listEnvVars()` - List all environment variables
- `setSecret(key, value)` - Set secret (platform only)
- `deleteSecret(key)` - Delete secret (platform only)
- `listSecretNames()` - List secret names (platform only)
- `isPlatformEnvironment()` - Check environment type
- `supportsSecrets()` - Check if secrets are supported

---

For more information, see the [main README](../README.md) or [CrunchyCone API documentation](CRUNCHYCONE_API_AUTH.md).